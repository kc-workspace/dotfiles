name: Main CI

on:
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  INSTALL_CLI: /tmp/chezmoi.sh
  CHEZMOI_BIN: /tmp/bin
  CHEZMOI: /tmp/bin/chezmoi

jobs:
  main:
    runs-on: ubuntu-latest
    env:
      KCDF_MODE: full
    steps:
      - name: Set up repository
        uses: actions/checkout@v4
      - name: Set up 1Password CLI
        uses: 1password/install-cli-action@v1
      - name: Check 1Password account
        run: op user get --me
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
      - name: Cache chezmoi
        id: cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CHEZMOI_BIN }}
          key: chezmoi-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('.chezmoiversion') }}
      - name: Download chezmoi install script
        if: steps.cache.outputs.cache-hit != 'true'
        run: curl -fsLSo $INSTALL_CLI get.chezmoi.io
      - name: Install chezmoi
        if: steps.cache.outputs.cache-hit != 'true'
        run: sh "$INSTALL_CLI" -d -b "$CHEZMOI_BIN" -t "v$(cat .chezmoiversion)"
      - name: Get chezmoi version
        run: $CHEZMOI --version
      - name: Try apply chezmoi config
        run: scripts/entrypoint.sh
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
